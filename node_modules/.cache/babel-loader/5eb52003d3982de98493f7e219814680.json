{"ast":null,"code":"\"use strict\"; // Copyright (c) 2018-2020 WalletLink.org <https://www.walletlink.org/>\n// Copyright (c) 2018-2020 Coinbase, Inc. <https://www.coinbase.com/>\n// Licensed under the Apache License, version 2.0\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WalletLinkRelay = void 0;\n\nconst bind_decorator_1 = __importDefault(require(\"bind-decorator\"));\n\nconst rxjs_1 = require(\"rxjs\");\n\nconst operators_1 = require(\"rxjs/operators\");\n\nconst WalletLinkAnalytics_1 = require(\"../connection/WalletLinkAnalytics\");\n\nconst WalletLinkConnection_1 = require(\"../connection/WalletLinkConnection\");\n\nconst init_1 = require(\"../init\");\n\nconst util_1 = require(\"../util\");\n\nconst aes256gcm = __importStar(require(\"./aes256gcm\"));\n\nconst Session_1 = require(\"./Session\");\n\nconst WalletLinkRelayAbstract_1 = require(\"./WalletLinkRelayAbstract\");\n\nconst Web3Method_1 = require(\"./Web3Method\");\n\nconst Web3RequestCanceledMessage_1 = require(\"./Web3RequestCanceledMessage\");\n\nconst Web3RequestMessage_1 = require(\"./Web3RequestMessage\");\n\nconst Web3Response_1 = require(\"./Web3Response\");\n\nconst Web3ResponseMessage_1 = require(\"./Web3ResponseMessage\");\n\nclass WalletLinkRelay {\n  constructor(options) {\n    this.accountsCallback = null;\n    this.chainCallback = null;\n    this.appName = \"\";\n    this.appLogoUrl = null;\n    this.subscriptions = new rxjs_1.Subscription();\n    this.walletLinkUrl = options.walletLinkUrl;\n    this.storage = options.storage;\n    this._session = Session_1.Session.load(options.storage) || new Session_1.Session(options.storage).save();\n    this.relayEventManager = options.relayEventManager;\n    this.walletLinkAnalytics = options.walletLinkAnalytics ? options.walletLinkAnalytics : new WalletLinkAnalytics_1.WalletLinkAnalytics();\n    this.connection = new WalletLinkConnection_1.WalletLinkConnection(this._session.id, this._session.key, this.walletLinkUrl, this.walletLinkAnalytics);\n    this.subscriptions.add(this.connection.incomingEvent$.pipe((0, operators_1.filter)(m => m.event === \"Web3Response\")).subscribe({\n      next: this.handleIncomingEvent\n    }));\n    this.subscriptions.add(this.connection.linked$.pipe((0, operators_1.skip)(1), (0, operators_1.tap)(linked => {\n      var _a;\n\n      this.isLinked = linked;\n      const cachedAddresses = this.storage.getItem(WalletLinkRelayAbstract_1.LOCAL_STORAGE_ADDRESSES_KEY);\n\n      if (cachedAddresses) {\n        const addresses = cachedAddresses.split(\" \");\n\n        if (addresses[0] !== \"\" && !linked) {\n          const sessionIdHash = Session_1.Session.hash(this._session.id);\n          (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.UNLINKED_ERROR_STATE, {\n            sessionIdHash\n          });\n        }\n      }\n    })).subscribe()); // if session is marked destroyed, reset and reload\n\n    this.subscriptions.add(this.connection.sessionConfig$.pipe((0, operators_1.filter)(c => !!c.metadata && c.metadata.__destroyed === \"1\")).subscribe(() => {\n      var _a;\n\n      const alreadyDestroyed = this.connection.isDestroyed;\n      (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.METADATA_DESTROYED, {\n        alreadyDestroyed,\n        sessionIdHash: Session_1.Session.hash(this._session.id)\n      });\n      return this.resetAndReload();\n    }));\n    this.subscriptions.add(this.connection.sessionConfig$.pipe((0, operators_1.filter)(c => c.metadata && c.metadata.WalletUsername !== undefined)).pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.WalletUsername, this._session.secret))).subscribe({\n      next: walletUsername => {\n        this.storage.setItem(WalletLinkRelayAbstract_1.WALLET_USER_NAME_KEY, walletUsername);\n      },\n      error: () => {\n        var _a;\n\n        (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n          message: \"Had error decrypting\",\n          value: \"username\"\n        });\n      }\n    }));\n    this.subscriptions.add(this.connection.sessionConfig$.pipe((0, operators_1.filter)(c => c.metadata && c.metadata.AppVersion !== undefined)).pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.AppVersion, this._session.secret))).subscribe({\n      next: appVersion => {\n        this.storage.setItem(WalletLinkRelayAbstract_1.APP_VERSION_KEY, appVersion);\n      },\n      error: () => {\n        var _a;\n\n        (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n          message: \"Had error decrypting\",\n          value: \"appversion\"\n        });\n      }\n    }));\n    this.subscriptions.add(this.connection.sessionConfig$.pipe((0, operators_1.filter)(c => c.metadata && c.metadata.ChainId !== undefined && c.metadata.JsonRpcUrl !== undefined)).pipe((0, operators_1.mergeMap)(c => (0, rxjs_1.zip)(aes256gcm.decrypt(c.metadata.ChainId, this._session.secret), aes256gcm.decrypt(c.metadata.JsonRpcUrl, this._session.secret)))).pipe((0, operators_1.distinctUntilChanged)()).subscribe({\n      next: _ref => {\n        let [chainId, jsonRpcUrl] = _ref;\n\n        if (this.chainCallback) {\n          this.chainCallback(chainId, jsonRpcUrl);\n        }\n      },\n      error: () => {\n        var _a;\n\n        (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n          message: \"Had error decrypting\",\n          value: \"chainId|jsonRpcUrl\"\n        });\n      }\n    }));\n    this.subscriptions.add(this.connection.sessionConfig$.pipe((0, operators_1.filter)(c => c.metadata && c.metadata.EthereumAddress !== undefined)).pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.EthereumAddress, this._session.secret))).subscribe({\n      next: selectedAddress => {\n        if (this.accountsCallback) {\n          this.accountsCallback([selectedAddress]);\n        }\n\n        if (WalletLinkRelay.accountRequestCallbackIds.size > 0) {\n          // We get the ethereum address from the metadata.  If for whatever\n          // reason we don't get a response via an explicit web3 message\n          // we can still fulfill the eip1102 request.\n          Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(id => {\n            const message = (0, Web3ResponseMessage_1.Web3ResponseMessage)({\n              id,\n              response: (0, Web3Response_1.RequestEthereumAccountsResponse)([selectedAddress])\n            });\n            this.invokeCallback(Object.assign(Object.assign({}, message), {\n              id\n            }));\n          });\n          WalletLinkRelay.accountRequestCallbackIds.clear();\n        }\n      },\n      error: () => {\n        var _a;\n\n        (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n          message: \"Had error decrypting\",\n          value: \"selectedAddress\"\n        });\n      }\n    }));\n    this.ui = options.walletLinkUIConstructor({\n      walletLinkUrl: options.walletLinkUrl,\n      version: options.version,\n      darkMode: options.darkMode,\n      session: this._session,\n      connected$: this.connection.connected$\n    });\n    this.connection.connect();\n  }\n\n  attachUI() {\n    this.ui.attach();\n  }\n\n  resetAndReload() {\n    this.connection.setSessionMetadata(\"__destroyed\", \"1\").pipe((0, operators_1.timeout)(1000), (0, operators_1.catchError)(_ => (0, rxjs_1.of)(null))).subscribe(_ => {\n      var _a, _b;\n\n      try {\n        this.subscriptions.unsubscribe();\n      } catch (err) {\n        (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n          message: \"Had error unsubscribing\"\n        });\n      }\n\n      (_b = this.walletLinkAnalytics) === null || _b === void 0 ? void 0 : _b.sendEvent(init_1.EVENTS.SESSION_STATE_CHANGE, {\n        method: \"relay::resetAndReload\",\n        sessionMetadataChange: \"__destroyed, 1\",\n        sessionIdHash: Session_1.Session.hash(this._session.id)\n      });\n      this.connection.destroy();\n      this.storage.clear();\n      this.ui.reloadUI();\n    }, err => {\n      var _a;\n\n      (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.FAILURE, {\n        method: \"relay::resetAndReload\",\n        message: `faled to reset and relod with ${err}`,\n        sessionIdHash: Session_1.Session.hash(this._session.id)\n      });\n    });\n  }\n\n  setAppInfo(appName, appLogoUrl) {\n    this.appName = appName;\n    this.appLogoUrl = appLogoUrl;\n  }\n\n  getStorageItem(key) {\n    return this.storage.getItem(key);\n  }\n\n  get session() {\n    return this._session;\n  }\n\n  setStorageItem(key, value) {\n    this.storage.setItem(key, value);\n  }\n\n  requestEthereumAccounts() {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.requestEthereumAccounts,\n      params: {\n        appName: this.appName,\n        appLogoUrl: this.appLogoUrl || null\n      }\n    });\n  }\n\n  signEthereumMessage(message, address, addPrefix, typedDataJson) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.signEthereumMessage,\n      params: {\n        message: (0, util_1.hexStringFromBuffer)(message, true),\n        address,\n        addPrefix,\n        typedDataJson: typedDataJson || null\n      }\n    });\n  }\n\n  ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.ethereumAddressFromSignedMessage,\n      params: {\n        message: (0, util_1.hexStringFromBuffer)(message, true),\n        signature: (0, util_1.hexStringFromBuffer)(signature, true),\n        addPrefix\n      }\n    });\n  }\n\n  signEthereumTransaction(params) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.signEthereumTransaction,\n      params: {\n        fromAddress: params.fromAddress,\n        toAddress: params.toAddress,\n        weiValue: (0, util_1.bigIntStringFromBN)(params.weiValue),\n        data: (0, util_1.hexStringFromBuffer)(params.data, true),\n        nonce: params.nonce,\n        gasPriceInWei: params.gasPriceInWei ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei) : null,\n        maxFeePerGas: params.gasPriceInWei ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei) : null,\n        maxPriorityFeePerGas: params.gasPriceInWei ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei) : null,\n        gasLimit: params.gasLimit ? (0, util_1.bigIntStringFromBN)(params.gasLimit) : null,\n        chainId: params.chainId,\n        shouldSubmit: false\n      }\n    });\n  }\n\n  signAndSubmitEthereumTransaction(params) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.signEthereumTransaction,\n      params: {\n        fromAddress: params.fromAddress,\n        toAddress: params.toAddress,\n        weiValue: (0, util_1.bigIntStringFromBN)(params.weiValue),\n        data: (0, util_1.hexStringFromBuffer)(params.data, true),\n        nonce: params.nonce,\n        gasPriceInWei: params.gasPriceInWei ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei) : null,\n        maxFeePerGas: params.maxFeePerGas ? (0, util_1.bigIntStringFromBN)(params.maxFeePerGas) : null,\n        maxPriorityFeePerGas: params.maxPriorityFeePerGas ? (0, util_1.bigIntStringFromBN)(params.maxPriorityFeePerGas) : null,\n        gasLimit: params.gasLimit ? (0, util_1.bigIntStringFromBN)(params.gasLimit) : null,\n        chainId: params.chainId,\n        shouldSubmit: true\n      }\n    });\n  }\n\n  submitEthereumTransaction(signedTransaction, chainId) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.submitEthereumTransaction,\n      params: {\n        signedTransaction: (0, util_1.hexStringFromBuffer)(signedTransaction, true),\n        chainId\n      }\n    });\n  }\n\n  scanQRCode(regExp) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.scanQRCode,\n      params: {\n        regExp\n      }\n    });\n  }\n\n  genericRequest(data, action) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.generic,\n      params: {\n        action,\n        data\n      }\n    });\n  }\n\n  addEthereumChain(chainId, rpcUrls, blockExplorerUrls, chainName, iconUrls, nativeCurrency) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.addEthereumChain,\n      params: {\n        chainId,\n        rpcUrls,\n        blockExplorerUrls,\n        chainName,\n        iconUrls,\n        nativeCurrency\n      }\n    });\n  }\n\n  sendGenericMessage(request) {\n    return this.sendRequest(request);\n  }\n\n  sendRequest(request) {\n    let hideSnackbarItem = null;\n    const id = (0, util_1.randomBytesHex)(8);\n\n    const cancel = () => {\n      this.publishWeb3RequestCanceledEvent(id);\n      this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n        id,\n        response: (0, Web3Response_1.ErrorResponse)(request.method, \"User rejected request\")\n      }));\n      hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n    };\n\n    const promise = new Promise((resolve, reject) => {\n      var _a;\n\n      const isRequestAccounts = request.method === Web3Method_1.Web3Method.requestEthereumAccounts;\n      const isSwitchEthereumChain = request.method === Web3Method_1.Web3Method.switchEthereumChain;\n\n      if (isRequestAccounts) {\n        const userAgent = ((_a = window === null || window === void 0 ? void 0 : window.navigator) === null || _a === void 0 ? void 0 : _a.userAgent) || null;\n\n        if (userAgent && /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {\n          window.location.href = `https://go.cb-w.com/xoXnYwQimhb?cb_url=${window.location.href}`;\n          return;\n        }\n\n        if (this.ui.inlineAccountsResponse()) {\n          const onAccounts = accounts => {\n            this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n              id,\n              response: (0, Web3Response_1.RequestEthereumAccountsResponse)(accounts)\n            }));\n          };\n\n          this.ui.requestEthereumAccounts({\n            onCancel: cancel,\n            onAccounts\n          });\n        } else {\n          this.ui.requestEthereumAccounts({\n            onCancel: cancel\n          });\n        }\n\n        WalletLinkRelay.accountRequestCallbackIds.add(id);\n      } else if (request.method === Web3Method_1.Web3Method.switchEthereumChain || request.method === Web3Method_1.Web3Method.addEthereumChain) {\n        const cancel = () => {\n          this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n            id,\n            response: (0, Web3Response_1.SwitchEthereumChainResponse)({\n              isApproved: false,\n              rpcUrl: \"\"\n            })\n          }));\n        };\n\n        const approve = rpcUrl => {\n          this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n            id,\n            response: (0, Web3Response_1.SwitchEthereumChainResponse)({\n              isApproved: true,\n              rpcUrl\n            })\n          }));\n        };\n\n        this.ui.switchEthereumChain({\n          onCancel: cancel,\n          onApprove: approve,\n          chainId: request.params.chainId\n        });\n\n        if (!this.ui.inlineSwitchEthereumChain()) {\n          hideSnackbarItem = this.ui.showConnecting({\n            onCancel: cancel,\n            onResetConnection: this.resetAndReload\n          });\n        }\n      } else if (this.ui.isStandalone()) {\n        const onCancel = () => {\n          this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n            id,\n            response: (0, Web3Response_1.ErrorResponse)(request.method, \"User rejected request\")\n          }));\n        };\n\n        const onSuccess = response => {\n          this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n            id,\n            response: response\n          }));\n        };\n\n        switch (request.method) {\n          case Web3Method_1.Web3Method.signEthereumMessage:\n            this.ui.signEthereumMessage({\n              request: request,\n              onSuccess,\n              onCancel\n            });\n            break;\n\n          case Web3Method_1.Web3Method.signEthereumTransaction:\n            this.ui.signEthereumTransaction({\n              request: request,\n              onSuccess,\n              onCancel\n            });\n            break;\n\n          case Web3Method_1.Web3Method.submitEthereumTransaction:\n            this.ui.submitEthereumTransaction({\n              request: request,\n              onSuccess,\n              onCancel\n            });\n            break;\n\n          case Web3Method_1.Web3Method.ethereumAddressFromSignedMessage:\n            this.ui.ethereumAddressFromSignedMessage({\n              request: request,\n              onSuccess\n            });\n            break;\n\n          default:\n            onCancel();\n            break;\n        }\n      } else {\n        hideSnackbarItem = this.ui.showConnecting({\n          onCancel: cancel,\n          onResetConnection: this.resetAndReload\n        });\n      }\n\n      this.relayEventManager.callbacks.set(id, response => {\n        this.ui.hideRequestEthereumAccounts();\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n\n        if (response.errorMessage) {\n          return reject(new Error(response.errorMessage));\n        }\n\n        resolve(response);\n      });\n\n      if (isRequestAccounts && this.ui.inlineAccountsResponse() || isSwitchEthereumChain && this.ui.inlineSwitchEthereumChain() || this.ui.isStandalone()) {\n        return;\n      }\n\n      this.publishWeb3RequestEvent(id, request);\n    });\n    return {\n      promise,\n      cancel\n    };\n  }\n\n  setConnectDisabled(disabled) {\n    this.ui.setConnectDisabled(disabled);\n  }\n\n  setAccountsCallback(accountsCallback) {\n    this.accountsCallback = accountsCallback;\n  }\n\n  setChainCallback(chainCallback) {\n    this.chainCallback = chainCallback;\n  }\n\n  publishWeb3RequestEvent(id, request) {\n    const message = (0, Web3RequestMessage_1.Web3RequestMessage)({\n      id,\n      request\n    });\n    this.subscriptions.add(this.publishEvent(\"Web3Request\", message, true).subscribe({\n      error: err => {\n        this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n          id: message.id,\n          response: {\n            method: message.request.method,\n            errorMessage: err.message\n          }\n        }));\n      }\n    }));\n  }\n\n  publishWeb3RequestCanceledEvent(id) {\n    const message = (0, Web3RequestCanceledMessage_1.Web3RequestCanceledMessage)(id);\n    this.subscriptions.add(this.publishEvent(\"Web3RequestCanceled\", message, false).subscribe());\n  }\n\n  publishEvent(event, message, callWebhook) {\n    const secret = this.session.secret;\n    return new rxjs_1.Observable(subscriber => {\n      aes256gcm.encrypt(JSON.stringify(Object.assign(Object.assign({}, message), {\n        origin: location.origin\n      })), secret).then(encrypted => {\n        subscriber.next(encrypted);\n        subscriber.complete();\n      });\n    }).pipe((0, operators_1.mergeMap)(encrypted => {\n      return this.connection.publishEvent(event, encrypted, callWebhook);\n    }));\n  }\n\n  handleIncomingEvent(event) {\n    try {\n      this.subscriptions.add(aes256gcm.decrypt(event.data, this.session.secret).pipe((0, operators_1.map)(c => JSON.parse(c))).subscribe({\n        next: json => {\n          const message = (0, Web3ResponseMessage_1.isWeb3ResponseMessage)(json) ? json : null;\n\n          if (!message) {\n            return;\n          }\n\n          this.handleWeb3ResponseMessage(message);\n        },\n        error: () => {\n          var _a;\n\n          (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n            message: \"Had error decrypting\",\n            value: \"incomingEvent\"\n          });\n        }\n      }));\n    } catch (_a) {\n      return;\n    }\n  }\n\n  handleWeb3ResponseMessage(message) {\n    const {\n      response\n    } = message;\n\n    if ((0, Web3Response_1.isRequestEthereumAccountsResponse)(response)) {\n      Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(id => this.invokeCallback(Object.assign(Object.assign({}, message), {\n        id\n      })));\n      WalletLinkRelay.accountRequestCallbackIds.clear();\n      return;\n    }\n\n    this.invokeCallback(message);\n  }\n\n  invokeCallback(message) {\n    const callback = this.relayEventManager.callbacks.get(message.id);\n\n    if (callback) {\n      callback(message.response);\n      this.relayEventManager.callbacks.delete(message.id);\n    }\n  }\n\n  switchEthereumChain(chainId) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.switchEthereumChain,\n      params: {\n        chainId\n      }\n    });\n  }\n\n}\n\nWalletLinkRelay.accountRequestCallbackIds = new Set();\n\n__decorate([bind_decorator_1.default], WalletLinkRelay.prototype, \"resetAndReload\", null);\n\n__decorate([bind_decorator_1.default], WalletLinkRelay.prototype, \"handleIncomingEvent\", null);\n\nexports.WalletLinkRelay = WalletLinkRelay;","map":{"version":3,"sources":["/Users/tanmayjuneja/Documents/demos/SmartDAO/node_modules/walletlink/dist/relay/WalletLinkRelay.js"],"names":["__createBinding","Object","create","o","m","k","k2","undefined","defineProperty","enumerable","get","__setModuleDefault","v","value","__decorate","decorators","target","key","desc","c","arguments","length","r","getOwnPropertyDescriptor","d","Reflect","decorate","i","__importStar","mod","__esModule","result","prototype","hasOwnProperty","call","__importDefault","exports","WalletLinkRelay","bind_decorator_1","require","rxjs_1","operators_1","WalletLinkAnalytics_1","WalletLinkConnection_1","init_1","util_1","aes256gcm","Session_1","WalletLinkRelayAbstract_1","Web3Method_1","Web3RequestCanceledMessage_1","Web3RequestMessage_1","Web3Response_1","Web3ResponseMessage_1","constructor","options","accountsCallback","chainCallback","appName","appLogoUrl","subscriptions","Subscription","walletLinkUrl","storage","_session","Session","load","save","relayEventManager","walletLinkAnalytics","WalletLinkAnalytics","connection","WalletLinkConnection","id","add","incomingEvent$","pipe","filter","event","subscribe","next","handleIncomingEvent","linked$","skip","tap","linked","_a","isLinked","cachedAddresses","getItem","LOCAL_STORAGE_ADDRESSES_KEY","addresses","split","sessionIdHash","hash","sendEvent","EVENTS","UNLINKED_ERROR_STATE","sessionConfig$","metadata","__destroyed","alreadyDestroyed","isDestroyed","METADATA_DESTROYED","resetAndReload","WalletUsername","mergeMap","decrypt","secret","walletUsername","setItem","WALLET_USER_NAME_KEY","error","GENERAL_ERROR","message","AppVersion","appVersion","APP_VERSION_KEY","ChainId","JsonRpcUrl","zip","distinctUntilChanged","chainId","jsonRpcUrl","EthereumAddress","selectedAddress","accountRequestCallbackIds","size","Array","from","values","forEach","Web3ResponseMessage","response","RequestEthereumAccountsResponse","invokeCallback","assign","clear","ui","walletLinkUIConstructor","version","darkMode","session","connected$","connect","attachUI","attach","setSessionMetadata","timeout","catchError","_","of","_b","unsubscribe","err","SESSION_STATE_CHANGE","method","sessionMetadataChange","destroy","reloadUI","FAILURE","setAppInfo","getStorageItem","setStorageItem","requestEthereumAccounts","sendRequest","Web3Method","params","signEthereumMessage","address","addPrefix","typedDataJson","hexStringFromBuffer","ethereumAddressFromSignedMessage","signature","signEthereumTransaction","fromAddress","toAddress","weiValue","bigIntStringFromBN","data","nonce","gasPriceInWei","maxFeePerGas","maxPriorityFeePerGas","gasLimit","shouldSubmit","signAndSubmitEthereumTransaction","submitEthereumTransaction","signedTransaction","scanQRCode","regExp","genericRequest","action","generic","addEthereumChain","rpcUrls","blockExplorerUrls","chainName","iconUrls","nativeCurrency","sendGenericMessage","request","hideSnackbarItem","randomBytesHex","cancel","publishWeb3RequestCanceledEvent","handleWeb3ResponseMessage","ErrorResponse","promise","Promise","resolve","reject","isRequestAccounts","isSwitchEthereumChain","switchEthereumChain","userAgent","window","navigator","test","location","href","inlineAccountsResponse","onAccounts","accounts","onCancel","SwitchEthereumChainResponse","isApproved","rpcUrl","approve","onApprove","inlineSwitchEthereumChain","showConnecting","onResetConnection","isStandalone","onSuccess","callbacks","set","hideRequestEthereumAccounts","errorMessage","Error","publishWeb3RequestEvent","setConnectDisabled","disabled","setAccountsCallback","setChainCallback","Web3RequestMessage","publishEvent","Web3RequestCanceledMessage","callWebhook","Observable","subscriber","encrypt","JSON","stringify","origin","then","encrypted","complete","map","parse","json","isWeb3ResponseMessage","isRequestEthereumAccountsResponse","callback","delete","Set","default"],"mappings":"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","sourcesContent":["\"use strict\";\n// Copyright (c) 2018-2020 WalletLink.org <https://www.walletlink.org/>\n// Copyright (c) 2018-2020 Coinbase, Inc. <https://www.coinbase.com/>\n// Licensed under the Apache License, version 2.0\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.WalletLinkRelay = void 0;\nconst bind_decorator_1 = __importDefault(require(\"bind-decorator\"));\nconst rxjs_1 = require(\"rxjs\");\nconst operators_1 = require(\"rxjs/operators\");\nconst WalletLinkAnalytics_1 = require(\"../connection/WalletLinkAnalytics\");\nconst WalletLinkConnection_1 = require(\"../connection/WalletLinkConnection\");\nconst init_1 = require(\"../init\");\nconst util_1 = require(\"../util\");\nconst aes256gcm = __importStar(require(\"./aes256gcm\"));\nconst Session_1 = require(\"./Session\");\nconst WalletLinkRelayAbstract_1 = require(\"./WalletLinkRelayAbstract\");\nconst Web3Method_1 = require(\"./Web3Method\");\nconst Web3RequestCanceledMessage_1 = require(\"./Web3RequestCanceledMessage\");\nconst Web3RequestMessage_1 = require(\"./Web3RequestMessage\");\nconst Web3Response_1 = require(\"./Web3Response\");\nconst Web3ResponseMessage_1 = require(\"./Web3ResponseMessage\");\nclass WalletLinkRelay {\n    constructor(options) {\n        this.accountsCallback = null;\n        this.chainCallback = null;\n        this.appName = \"\";\n        this.appLogoUrl = null;\n        this.subscriptions = new rxjs_1.Subscription();\n        this.walletLinkUrl = options.walletLinkUrl;\n        this.storage = options.storage;\n        this._session =\n            Session_1.Session.load(options.storage) || new Session_1.Session(options.storage).save();\n        this.relayEventManager = options.relayEventManager;\n        this.walletLinkAnalytics = options.walletLinkAnalytics\n            ? options.walletLinkAnalytics\n            : new WalletLinkAnalytics_1.WalletLinkAnalytics();\n        this.connection = new WalletLinkConnection_1.WalletLinkConnection(this._session.id, this._session.key, this.walletLinkUrl, this.walletLinkAnalytics);\n        this.subscriptions.add(this.connection.incomingEvent$\n            .pipe((0, operators_1.filter)(m => m.event === \"Web3Response\"))\n            .subscribe({ next: this.handleIncomingEvent }));\n        this.subscriptions.add(this.connection.linked$\n            .pipe((0, operators_1.skip)(1), (0, operators_1.tap)((linked) => {\n            var _a;\n            this.isLinked = linked;\n            const cachedAddresses = this.storage.getItem(WalletLinkRelayAbstract_1.LOCAL_STORAGE_ADDRESSES_KEY);\n            if (cachedAddresses) {\n                const addresses = cachedAddresses.split(\" \");\n                if (addresses[0] !== \"\" && !linked) {\n                    const sessionIdHash = Session_1.Session.hash(this._session.id);\n                    (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.UNLINKED_ERROR_STATE, { sessionIdHash });\n                }\n            }\n        }))\n            .subscribe());\n        // if session is marked destroyed, reset and reload\n        this.subscriptions.add(this.connection.sessionConfig$\n            .pipe((0, operators_1.filter)(c => !!c.metadata && c.metadata.__destroyed === \"1\"))\n            .subscribe(() => {\n            var _a;\n            const alreadyDestroyed = this.connection.isDestroyed;\n            (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.METADATA_DESTROYED, {\n                alreadyDestroyed,\n                sessionIdHash: Session_1.Session.hash(this._session.id)\n            });\n            return this.resetAndReload();\n        }));\n        this.subscriptions.add(this.connection.sessionConfig$\n            .pipe((0, operators_1.filter)(c => c.metadata && c.metadata.WalletUsername !== undefined))\n            .pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.WalletUsername, this._session.secret)))\n            .subscribe({\n            next: walletUsername => {\n                this.storage.setItem(WalletLinkRelayAbstract_1.WALLET_USER_NAME_KEY, walletUsername);\n            },\n            error: () => {\n                var _a;\n                (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error decrypting\",\n                    value: \"username\"\n                });\n            }\n        }));\n        this.subscriptions.add(this.connection.sessionConfig$\n            .pipe((0, operators_1.filter)(c => c.metadata && c.metadata.AppVersion !== undefined))\n            .pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.AppVersion, this._session.secret)))\n            .subscribe({\n            next: appVersion => {\n                this.storage.setItem(WalletLinkRelayAbstract_1.APP_VERSION_KEY, appVersion);\n            },\n            error: () => {\n                var _a;\n                (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error decrypting\",\n                    value: \"appversion\"\n                });\n            }\n        }));\n        this.subscriptions.add(this.connection.sessionConfig$\n            .pipe((0, operators_1.filter)(c => c.metadata &&\n            c.metadata.ChainId !== undefined &&\n            c.metadata.JsonRpcUrl !== undefined))\n            .pipe((0, operators_1.mergeMap)(c => (0, rxjs_1.zip)(aes256gcm.decrypt(c.metadata.ChainId, this._session.secret), aes256gcm.decrypt(c.metadata.JsonRpcUrl, this._session.secret))))\n            .pipe((0, operators_1.distinctUntilChanged)())\n            .subscribe({\n            next: ([chainId, jsonRpcUrl]) => {\n                if (this.chainCallback) {\n                    this.chainCallback(chainId, jsonRpcUrl);\n                }\n            },\n            error: () => {\n                var _a;\n                (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error decrypting\",\n                    value: \"chainId|jsonRpcUrl\"\n                });\n            }\n        }));\n        this.subscriptions.add(this.connection.sessionConfig$\n            .pipe((0, operators_1.filter)(c => c.metadata && c.metadata.EthereumAddress !== undefined))\n            .pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.EthereumAddress, this._session.secret)))\n            .subscribe({\n            next: selectedAddress => {\n                if (this.accountsCallback) {\n                    this.accountsCallback([selectedAddress]);\n                }\n                if (WalletLinkRelay.accountRequestCallbackIds.size > 0) {\n                    // We get the ethereum address from the metadata.  If for whatever\n                    // reason we don't get a response via an explicit web3 message\n                    // we can still fulfill the eip1102 request.\n                    Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(id => {\n                        const message = (0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                            id,\n                            response: (0, Web3Response_1.RequestEthereumAccountsResponse)([\n                                selectedAddress\n                            ])\n                        });\n                        this.invokeCallback(Object.assign(Object.assign({}, message), { id }));\n                    });\n                    WalletLinkRelay.accountRequestCallbackIds.clear();\n                }\n            },\n            error: () => {\n                var _a;\n                (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error decrypting\",\n                    value: \"selectedAddress\"\n                });\n            }\n        }));\n        this.ui = options.walletLinkUIConstructor({\n            walletLinkUrl: options.walletLinkUrl,\n            version: options.version,\n            darkMode: options.darkMode,\n            session: this._session,\n            connected$: this.connection.connected$\n        });\n        this.connection.connect();\n    }\n    attachUI() {\n        this.ui.attach();\n    }\n    resetAndReload() {\n        this.connection\n            .setSessionMetadata(\"__destroyed\", \"1\")\n            .pipe((0, operators_1.timeout)(1000), (0, operators_1.catchError)(_ => (0, rxjs_1.of)(null)))\n            .subscribe(_ => {\n            var _a, _b;\n            try {\n                this.subscriptions.unsubscribe();\n            }\n            catch (err) {\n                (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error unsubscribing\"\n                });\n            }\n            (_b = this.walletLinkAnalytics) === null || _b === void 0 ? void 0 : _b.sendEvent(init_1.EVENTS.SESSION_STATE_CHANGE, {\n                method: \"relay::resetAndReload\",\n                sessionMetadataChange: \"__destroyed, 1\",\n                sessionIdHash: Session_1.Session.hash(this._session.id)\n            });\n            this.connection.destroy();\n            this.storage.clear();\n            this.ui.reloadUI();\n        }, err => {\n            var _a;\n            (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.FAILURE, {\n                method: \"relay::resetAndReload\",\n                message: `faled to reset and relod with ${err}`,\n                sessionIdHash: Session_1.Session.hash(this._session.id)\n            });\n        });\n    }\n    setAppInfo(appName, appLogoUrl) {\n        this.appName = appName;\n        this.appLogoUrl = appLogoUrl;\n    }\n    getStorageItem(key) {\n        return this.storage.getItem(key);\n    }\n    get session() {\n        return this._session;\n    }\n    setStorageItem(key, value) {\n        this.storage.setItem(key, value);\n    }\n    requestEthereumAccounts() {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.requestEthereumAccounts,\n            params: {\n                appName: this.appName,\n                appLogoUrl: this.appLogoUrl || null\n            }\n        });\n    }\n    signEthereumMessage(message, address, addPrefix, typedDataJson) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumMessage,\n            params: {\n                message: (0, util_1.hexStringFromBuffer)(message, true),\n                address,\n                addPrefix,\n                typedDataJson: typedDataJson || null\n            }\n        });\n    }\n    ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.ethereumAddressFromSignedMessage,\n            params: {\n                message: (0, util_1.hexStringFromBuffer)(message, true),\n                signature: (0, util_1.hexStringFromBuffer)(signature, true),\n                addPrefix\n            }\n        });\n    }\n    signEthereumTransaction(params) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumTransaction,\n            params: {\n                fromAddress: params.fromAddress,\n                toAddress: params.toAddress,\n                weiValue: (0, util_1.bigIntStringFromBN)(params.weiValue),\n                data: (0, util_1.hexStringFromBuffer)(params.data, true),\n                nonce: params.nonce,\n                gasPriceInWei: params.gasPriceInWei\n                    ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei)\n                    : null,\n                maxFeePerGas: params.gasPriceInWei\n                    ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei)\n                    : null,\n                maxPriorityFeePerGas: params.gasPriceInWei\n                    ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei)\n                    : null,\n                gasLimit: params.gasLimit ? (0, util_1.bigIntStringFromBN)(params.gasLimit) : null,\n                chainId: params.chainId,\n                shouldSubmit: false\n            }\n        });\n    }\n    signAndSubmitEthereumTransaction(params) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumTransaction,\n            params: {\n                fromAddress: params.fromAddress,\n                toAddress: params.toAddress,\n                weiValue: (0, util_1.bigIntStringFromBN)(params.weiValue),\n                data: (0, util_1.hexStringFromBuffer)(params.data, true),\n                nonce: params.nonce,\n                gasPriceInWei: params.gasPriceInWei\n                    ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei)\n                    : null,\n                maxFeePerGas: params.maxFeePerGas\n                    ? (0, util_1.bigIntStringFromBN)(params.maxFeePerGas)\n                    : null,\n                maxPriorityFeePerGas: params.maxPriorityFeePerGas\n                    ? (0, util_1.bigIntStringFromBN)(params.maxPriorityFeePerGas)\n                    : null,\n                gasLimit: params.gasLimit ? (0, util_1.bigIntStringFromBN)(params.gasLimit) : null,\n                chainId: params.chainId,\n                shouldSubmit: true\n            }\n        });\n    }\n    submitEthereumTransaction(signedTransaction, chainId) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.submitEthereumTransaction,\n            params: {\n                signedTransaction: (0, util_1.hexStringFromBuffer)(signedTransaction, true),\n                chainId\n            }\n        });\n    }\n    scanQRCode(regExp) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.scanQRCode,\n            params: { regExp }\n        });\n    }\n    genericRequest(data, action) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.generic,\n            params: {\n                action,\n                data\n            }\n        });\n    }\n    addEthereumChain(chainId, rpcUrls, blockExplorerUrls, chainName, iconUrls, nativeCurrency) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.addEthereumChain,\n            params: {\n                chainId,\n                rpcUrls,\n                blockExplorerUrls,\n                chainName,\n                iconUrls,\n                nativeCurrency\n            }\n        });\n    }\n    sendGenericMessage(request) {\n        return this.sendRequest(request);\n    }\n    sendRequest(request) {\n        let hideSnackbarItem = null;\n        const id = (0, util_1.randomBytesHex)(8);\n        const cancel = () => {\n            this.publishWeb3RequestCanceledEvent(id);\n            this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                id,\n                response: (0, Web3Response_1.ErrorResponse)(request.method, \"User rejected request\")\n            }));\n            hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n        };\n        const promise = new Promise((resolve, reject) => {\n            var _a;\n            const isRequestAccounts = request.method === Web3Method_1.Web3Method.requestEthereumAccounts;\n            const isSwitchEthereumChain = request.method === Web3Method_1.Web3Method.switchEthereumChain;\n            if (isRequestAccounts) {\n                const userAgent = ((_a = window === null || window === void 0 ? void 0 : window.navigator) === null || _a === void 0 ? void 0 : _a.userAgent) || null;\n                if (userAgent &&\n                    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {\n                    window.location.href = `https://go.cb-w.com/xoXnYwQimhb?cb_url=${window.location.href}`;\n                    return;\n                }\n                if (this.ui.inlineAccountsResponse()) {\n                    const onAccounts = (accounts) => {\n                        this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                            id,\n                            response: (0, Web3Response_1.RequestEthereumAccountsResponse)(accounts)\n                        }));\n                    };\n                    this.ui.requestEthereumAccounts({\n                        onCancel: cancel,\n                        onAccounts\n                    });\n                }\n                else {\n                    this.ui.requestEthereumAccounts({\n                        onCancel: cancel\n                    });\n                }\n                WalletLinkRelay.accountRequestCallbackIds.add(id);\n            }\n            else if (request.method === Web3Method_1.Web3Method.switchEthereumChain ||\n                request.method === Web3Method_1.Web3Method.addEthereumChain) {\n                const cancel = () => {\n                    this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                        id,\n                        response: (0, Web3Response_1.SwitchEthereumChainResponse)({ isApproved: false, rpcUrl: \"\" })\n                    }));\n                };\n                const approve = (rpcUrl) => {\n                    this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                        id,\n                        response: (0, Web3Response_1.SwitchEthereumChainResponse)({ isApproved: true, rpcUrl })\n                    }));\n                };\n                this.ui.switchEthereumChain({\n                    onCancel: cancel,\n                    onApprove: approve,\n                    chainId: request.params.chainId\n                });\n                if (!this.ui.inlineSwitchEthereumChain()) {\n                    hideSnackbarItem = this.ui.showConnecting({\n                        onCancel: cancel,\n                        onResetConnection: this.resetAndReload\n                    });\n                }\n            }\n            else if (this.ui.isStandalone()) {\n                const onCancel = () => {\n                    this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                        id,\n                        response: (0, Web3Response_1.ErrorResponse)(request.method, \"User rejected request\")\n                    }));\n                };\n                const onSuccess = (response) => {\n                    this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                        id,\n                        response: response\n                    }));\n                };\n                switch (request.method) {\n                    case Web3Method_1.Web3Method.signEthereumMessage:\n                        this.ui.signEthereumMessage({\n                            request: request,\n                            onSuccess,\n                            onCancel\n                        });\n                        break;\n                    case Web3Method_1.Web3Method.signEthereumTransaction:\n                        this.ui.signEthereumTransaction({\n                            request: request,\n                            onSuccess,\n                            onCancel\n                        });\n                        break;\n                    case Web3Method_1.Web3Method.submitEthereumTransaction:\n                        this.ui.submitEthereumTransaction({\n                            request: request,\n                            onSuccess,\n                            onCancel\n                        });\n                        break;\n                    case Web3Method_1.Web3Method.ethereumAddressFromSignedMessage:\n                        this.ui.ethereumAddressFromSignedMessage({\n                            request: request,\n                            onSuccess\n                        });\n                        break;\n                    default:\n                        onCancel();\n                        break;\n                }\n            }\n            else {\n                hideSnackbarItem = this.ui.showConnecting({\n                    onCancel: cancel,\n                    onResetConnection: this.resetAndReload\n                });\n            }\n            this.relayEventManager.callbacks.set(id, response => {\n                this.ui.hideRequestEthereumAccounts();\n                hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n                if (response.errorMessage) {\n                    return reject(new Error(response.errorMessage));\n                }\n                resolve(response);\n            });\n            if ((isRequestAccounts && this.ui.inlineAccountsResponse()) ||\n                (isSwitchEthereumChain && this.ui.inlineSwitchEthereumChain()) ||\n                this.ui.isStandalone()) {\n                return;\n            }\n            this.publishWeb3RequestEvent(id, request);\n        });\n        return { promise, cancel };\n    }\n    setConnectDisabled(disabled) {\n        this.ui.setConnectDisabled(disabled);\n    }\n    setAccountsCallback(accountsCallback) {\n        this.accountsCallback = accountsCallback;\n    }\n    setChainCallback(chainCallback) {\n        this.chainCallback = chainCallback;\n    }\n    publishWeb3RequestEvent(id, request) {\n        const message = (0, Web3RequestMessage_1.Web3RequestMessage)({ id, request });\n        this.subscriptions.add(this.publishEvent(\"Web3Request\", message, true).subscribe({\n            error: err => {\n                this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                    id: message.id,\n                    response: {\n                        method: message.request.method,\n                        errorMessage: err.message\n                    }\n                }));\n            }\n        }));\n    }\n    publishWeb3RequestCanceledEvent(id) {\n        const message = (0, Web3RequestCanceledMessage_1.Web3RequestCanceledMessage)(id);\n        this.subscriptions.add(this.publishEvent(\"Web3RequestCanceled\", message, false).subscribe());\n    }\n    publishEvent(event, message, callWebhook) {\n        const secret = this.session.secret;\n        return new rxjs_1.Observable(subscriber => {\n            aes256gcm\n                .encrypt(JSON.stringify(Object.assign(Object.assign({}, message), { origin: location.origin })), secret)\n                .then((encrypted) => {\n                subscriber.next(encrypted);\n                subscriber.complete();\n            });\n        }).pipe((0, operators_1.mergeMap)((encrypted) => {\n            return this.connection.publishEvent(event, encrypted, callWebhook);\n        }));\n    }\n    handleIncomingEvent(event) {\n        try {\n            this.subscriptions.add(aes256gcm\n                .decrypt(event.data, this.session.secret)\n                .pipe((0, operators_1.map)(c => JSON.parse(c)))\n                .subscribe({\n                next: json => {\n                    const message = (0, Web3ResponseMessage_1.isWeb3ResponseMessage)(json) ? json : null;\n                    if (!message) {\n                        return;\n                    }\n                    this.handleWeb3ResponseMessage(message);\n                },\n                error: () => {\n                    var _a;\n                    (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n                        message: \"Had error decrypting\",\n                        value: \"incomingEvent\"\n                    });\n                }\n            }));\n        }\n        catch (_a) {\n            return;\n        }\n    }\n    handleWeb3ResponseMessage(message) {\n        const { response } = message;\n        if ((0, Web3Response_1.isRequestEthereumAccountsResponse)(response)) {\n            Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(id => this.invokeCallback(Object.assign(Object.assign({}, message), { id })));\n            WalletLinkRelay.accountRequestCallbackIds.clear();\n            return;\n        }\n        this.invokeCallback(message);\n    }\n    invokeCallback(message) {\n        const callback = this.relayEventManager.callbacks.get(message.id);\n        if (callback) {\n            callback(message.response);\n            this.relayEventManager.callbacks.delete(message.id);\n        }\n    }\n    switchEthereumChain(chainId) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.switchEthereumChain,\n            params: {\n                chainId\n            }\n        });\n    }\n}\nWalletLinkRelay.accountRequestCallbackIds = new Set();\n__decorate([\n    bind_decorator_1.default\n], WalletLinkRelay.prototype, \"resetAndReload\", null);\n__decorate([\n    bind_decorator_1.default\n], WalletLinkRelay.prototype, \"handleIncomingEvent\", null);\nexports.WalletLinkRelay = WalletLinkRelay;\n"]},"metadata":{},"sourceType":"script"}